{% extends "core/base.html" %}
{% block title %}Medical Records ‚Äî MediCare Pro{% endblock %}
{% block extra_css %}
<style>
  .tab-container { display: flex; gap: 1rem; margin-bottom: 2rem; }
  .tab-btn { 
    padding: 12px 24px; border: 2px solid var(--border); 
    border-radius: 12px; background: white; cursor: pointer;
    font-weight: 600; transition: all 0.3s; min-width: 140px;
  }
  .tab-btn.active { background: var(--brand); color: white; border-color: var(--brand); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  .record-item, .prescription-item { 
    background: white; border-radius: 12px; padding: 20px; 
    margin-bottom: 16px; box-shadow: var(--shadow); border-left: 4px solid var(--brand);
  }
  .time-since { font-size: 0.85rem; color: var(--muted); }
  .edit-5min { background: var(--success) !important; color: white !important; }
  
  .prescription-btn { 
    width: 120px; height: 38px; font-size: 0.85rem; 
    margin-left: 12px; padding: 0 16px;
  }
  .file-desc-input { 
    width: 100%; margin-bottom: 12px; 
    border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px;
  }
  .file-preview { 
    max-width: 200px; max-height: 150px; 
    border-radius: 8px; margin-top: 8px; display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:900px;margin:28px auto;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Medical Records & Prescriptions</h2>
    {% if user.role == 'doctor' %}
      <button class="btn btn-primary" onclick="openPrescriptionModal()">
        ‚ûï New Prescription
      </button>
    {% endif %}
  </div>

  <!-- TABS -->
  <div class="tab-container">
    <button class="tab-btn active" onclick="switchTab('records')">üìã Records ({{ records|length }})</button>
    <button class="tab-btn" onclick="switchTab('prescriptions')">üíä Prescriptions ({{ prescriptions|length }})</button>
  </div>

  <!-- RECORDS TAB -->
  <div id="records-tab" class="tab-content active">
    {% if records %}
      {% for record in records %}
        <div class="record-item">
          <div class="d-flex justify-content-between">
            <div>
              <h5>{{ record.content|truncatewords:15 }}</h5>
              <div class="time-since">
                Created: {{ record.created_at|timesince }} ago 
                {% if record.updated_at != record.created_at %}
                  | Updated: {{ record.updated_at|timesince }} ago
                {% endif %}
                by {{ record.author.get_full_name }}
              </div>
              {% if record.attachment %}
                <div>
                  üìé <a href="{{ record.attachment.url }}" target="_blank">{{ record.file_description }}</a>
                </div>
              {% endif %}
            </div>
            {% if user.role == 'doctor' and record.created_at > now|date_sub:"5 minutes" %}
              <button class="btn btn-sm btn-warning edit-5min" onclick="editRecord({{ record.pk }})">
                ‚úèÔ∏è Edit ({{ record.created_at|timeuntil }} left)
              </button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-center py-5">
        <i class="fas fa-file-medical fa-3x text-muted mb-3"></i>
        <h5>No medical records yet</h5>
        {% if user.role == 'doctor' %}
          <p>Add your first clinical note below</p>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- PRESCRIPTIONS TAB -->
  <div id="prescriptions-tab" class="tab-content">
    {% if prescriptions %}
      {% for prescription in prescriptions %}
        <div class="prescription-item">
          <div class="d-flex justify-content-between align-items-start">
            <div style="flex: 1;">
              <h5>{{ prescription.medication_name }}</h5>
              <div class="mb-2">
                <strong>Dosage:</strong> {{ prescription.dosage }}<br>
                <strong>Frequency:</strong> {{ prescription.frequency }}<br>
                <strong>Duration:</strong> {{ prescription.duration }}
              </div>
              {% if prescription.instructions %}
                <div class="bg-light p-2 rounded">
                  <strong>Instructions:</strong> {{ prescription.instructions }}
                </div>
              {% endif %}
              <div class="time-since mt-2">
                Prescribed: {{ prescription.prescribed_date }} 
                by {{ prescription.doctor.get_full_name }}
              </div>
            </div>
            {% if user.role == 'doctor' and prescription.prescribed_date > now|date_sub:"5 minutes" %}
              <button class="btn btn-sm btn-warning edit-5min" onclick="editPrescription({{ prescription.pk }})">
                ‚úèÔ∏è Edit ({{ prescription.prescribed_date|timeuntil }} left)
              </button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-center py-5">
        <i class="fas fa-prescription-bottle fa-3x text-muted mb-3"></i>
        <h5>No prescriptions yet</h5>
        {% if user.role == 'doctor' %}
          <p>Prescribe first medication using ‚ûï button above</p>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- NEW PRESCRIPTION MODAL -->
  <div id="prescriptionModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;">
    <div style="background:white;border-radius:16px;margin:5% auto;padding:2rem;max-width:600px;max-height:90vh;overflow-y:auto;">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>‚ûï New Prescription</h4>
        <button onclick="closePrescriptionModal()" style="font-size:1.5rem;border:none;background:none;cursor:pointer;">√ó</button>
      </div>
      
      <form id="prescriptionForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="patient_id" value="{{ patient.pk }}">
        
        <div class="mb-4">
          <label>Patient (Auto-filled)</label>
          <input type="text" class="form-control" value="{{ patient.full_name }} - {{ patient.user.email }}" readonly>
        </div>
        
        <div class="mb-3">
          <label>Medication Name *</label>
          <input type="text" name="medication_name" class="form-control" required placeholder="e.g., Paracetamol">
        </div>
        
        <div class="row">
          <div class="col-md-4 mb-3">
            <label>Dosage *</label>
            <input type="text" name="dosage" class="form-control" required placeholder="500mg">
          </div>
          <div class="col-md-4 mb-3">
            <label>Frequency *</label>
            <input type="text" name="frequency" class="form-control" required placeholder="3x daily">
          </div>
          <div class="col-md-4 mb-3">
            <label>Duration *</label>
            <input type="text" name="duration" class="form-control" required placeholder="5 days">
          </div>
        </div>
        
        <div class="mb-4">
          <label>Instructions</label>
          <textarea name="instructions" class="form-control" rows="3" placeholder="Take after meals. Avoid alcohol."></textarea>
        </div>
        
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">‚úÖ Save Prescription</button>
          <button type="button" class="btn btn-ghost" onclick="closePrescriptionModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let editTimeout = null;

// Tab switching
function switchTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tabName + '-tab').classList.add('active');
}

// Prescription modal
function openPrescriptionModal() {
  document.getElementById('prescriptionModal').style.display = 'block';
  document.getElementById('prescriptionForm').reset();
}

function closePrescriptionModal() {
  document.getElementById('prescriptionModal').style.display = 'none';
}

// Edit functions (5 min window)
function editRecord(recordId) {
  // Open edit modal with 5 min timer
  console.log('Editing record', recordId);
}

function editPrescription(prescriptionId) {
  // Open edit modal with 5 min timer  
  console.log('Editing prescription', prescriptionId);
}

// Close modal on outside click
window.onclick = function(event) {
  const modal = document.getElementById('prescriptionModal');
  if (event.target == modal) {
    closePrescriptionModal();
  }
}
</script>

{% endblock %}
