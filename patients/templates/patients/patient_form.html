{% extends "core/base.html" %}
{% load static %}

{% block title %}Add Patient ‚Äî MediCare Pro{% endblock %}

{% block extra_css %}
<style>
body { background: #f9fbfd; }
.form-back-row {
  max-width: 880px;
  margin: 0 auto;
  display: flex; justify-content: flex-end; margin-top: 32px; margin-bottom: 0;
}
.btn-back {
  padding: 13px 30px;
  background: #fff;
  color: #64748b;
  border: 2px solid #cbd5e1;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1.08rem;
  text-decoration: none;
  transition: all 0.2s;
  display: inline-block; outline: none; cursor: pointer;
  box-shadow: 0 1px 8px 0 rgba(44,62,80,0.05); margin-bottom: 12px;
}
.btn-back:hover, .btn-back:focus {
  background: #f8fafc; border-color: #94a3b8; color: #475569;
}
.form-wrapper { max-width: 880px; margin: 0 auto 42px auto; padding: 0 12px; }
.form-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.06); padding: 32px; margin-bottom: 24px;}
.patient-form-title { font-size: 1.8rem; font-weight: 700; color: #0f172a; margin-bottom: 10px; }
.patient-form-subtitle { color: #64748b; font-size: 0.99rem; margin-bottom: 22px; }
#form-errors { background: #fee2e2; color: #dc2626; border: 2px solid #fca5a5; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; font-size: 0.95rem; }
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.form-group { display: flex; flex-direction: column; }
.form-label { font-weight: 600; font-size: 0.9rem; color: #334155; margin-bottom: 8px; display: block; }
.form-label.required::after { content: " *"; color: #dc2626; }
.form-control {
  width: 100%; padding: 11px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; color: #334155; background: #fff; transition: all 0.2s; font-family: inherit;
}
.form-control:focus { outline: none; border-color: #00bcd4; box-shadow: 0 0 0 3px rgba(0,188,212,0.1);}
textarea.form-control { min-height: 100px; resize: vertical; }
.form-text { font-size: 0.85rem; color: #64748b; margin-top: 4px; }
.text-danger { color: #dc2626; font-size: 0.85rem; margin-top: 4px; font-weight: 500; }

/* Username status */
.username-status { font-size: 0.85rem; margin-top: 4px; }
.username-available { color: #10b981; }
.username-taken { color: #ef4444; }
.username-checking { color: #64748b; }

.photo-section-divided {
  margin-top: 24px;
  margin-bottom: 14px;
  padding-top: 22px;
  border-top: 2px solid #f1f5f9;
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  align-items: flex-start;
}
.photo-col-upload { flex: 1 1 220px; min-width: 220px; }
.photo-col-preview { flex: 0 0 auto; display: flex; flex-direction: column; align-items: flex-start; }
#photo-preview {
  height: 140px; width: 130px; object-fit: cover; border-radius: 9px;
  border: 3px solid #e2e8f0; background: #fff;
}
.photo-preview-hidden { display: none; }
#photo-filename-debug { color: #64748b; font-size: 0.92rem; margin-top: 5px; }

.form-actions {
  display: flex;
  gap: 18px;
  margin-top: 34px;
  flex-wrap: wrap;
  justify-content: flex-start;
}
.btn-submit {
  padding: 12px 32px;
  background: #00bcd4;
  color: #fff;
  border: 2px solid #00bcd4;
  border-radius: 8px;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s;
  flex: 1;
  min-width: 150px;
}
.btn-submit:hover {
  background: #00acc1;
  border-color: #00acc1;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,188,212,0.3);
}
.btn-cancel {
  padding: 12px 32px;
  background: #fff;
  color: #64748b;
  border: 2px solid #cbd5e1;
  border-radius: 8px;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s;
  flex: 1;
  min-width: 150px;
  text-decoration: none;
  text-align: center;
}
.btn-cancel:hover {
  background: #f8fafc;
  border-color: #94a3b8;
  color: #475569;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,188,212,0.08);
}
@media (max-width: 800px) {
  .form-row { grid-template-columns: 1fr; }
  .form-wrapper, .form-back-row { padding: 0 2px;}
  .form-card { padding: 18px; }
  .form-actions { flex-direction: column; gap: 15px; }
  .btn-submit, .btn-cancel { width: 100%; min-width: 0; }
  .btn-back { width: 100%; text-align: left;}
  .photo-section-divided { flex-direction: column; align-items: flex-start; gap: 14px;}
  .photo-col-upload { max-width: 280px; }
}
.patient-form input[type="file"] { width: 400px; max-width: 100%; }
.username-status { font-size: 0.85rem; margin-top: 4px; }
.username-available { color: #10b981; font-weight: 600; }
.username-taken { color: #ef4444; font-weight: 600; }
.username-checking { color: #64748b; }
</style>
{% endblock %}

{% block content %}
<div class="form-back-row">
  {% if request.user.is_superuser or request.user.role == 'admin' %}
    <a href="{% url 'admin_dashboard' %}" class="btn-back">‚Üê Back to Dashboard</a>
  {% elif request.user.role == 'doctor' %}
    <a href="{% url 'doctor_dashboard' %}" class="btn-back">‚Üê Back to Dashboard</a>
  {% elif request.user.role == 'receptionist' %}
    <a href="{% url 'reception_dashboard' %}" class="btn-back">‚Üê Back to Dashboard</a>
  {% elif request.user.role == 'patient' %}
    <a href="{% url 'patient_dashboard' %}" class="btn-back">‚Üê Back to Dashboard</a>
  {% else %}
    <a href="{% url 'home' %}" class="btn-back">‚Üê Back to Dashboard</a>
  {% endif %}
</div>

<div class="form-wrapper">
  <div class="form-card">
    <div class="patient-form-title">Add New Patient</div>
    <div class="patient-form-subtitle">Fill in patient details. <strong>Username = Password</strong> (easy login!)</div>
    <div id="form-errors" style="display:none;"></div>
    
    <form method="post" class="patient-form" id="patient-form" novalidate enctype="multipart/form-data">
      {% csrf_token %}
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label required">Username (also Password!)</label>
          {{ form.username }}
          <div id="usernameStatus" class="username-status"></div>
          {% if form.username.errors %}
            <div class="text-danger">{{ form.username.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label required" for="{{ form.first_name.id_for_label }}">First Name</label>
          {{ form.first_name }}
          {% if form.first_name.errors %}
            <div class="text-danger">{{ form.first_name.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label required" for="{{ form.last_name.id_for_label }}">Last Name</label>
          {{ form.last_name }}
          {% if form.last_name.errors %}
            <div class="text-danger">{{ form.last_name.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label required" for="id_date_of_birth">Date of Birth</label>
          <input id="id_date_of_birth" name="date_of_birth" type="date" class="form-control" autocomplete="bday" value="{{ form.date_of_birth.value|default_if_none:'' }}" placeholder="YYYY-MM-DD" required />
          <div class="form-text">Only past dates allowed.</div>
          {% if form.date_of_birth.errors %}
            <div class="text-danger">{{ form.date_of_birth.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label required" for="{{ form.phone.id_for_label }}">Phone Number</label>
          {{ form.phone }}
          <div class="form-text">Format: +91 1234567890 or 1234567890</div>
          {% if form.phone.errors %}
            <div class="text-danger">{{ form.phone.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label required" for="{{ form.email.id_for_label }}">Email Address</label>
          {{ form.email }}
          <div class="form-text">Patient login email</div>
          {% if form.email.errors %}
            <div class="text-danger">{{ form.email.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="{{ form.emergency_contact.id_for_label }}">Emergency Contact</label>
          {{ form.emergency_contact }}
          <div class="form-text">Another phone for emergencies</div>
          {% if form.emergency_contact.errors %}
            <div class="text-danger">{{ form.emergency_contact.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label" for="{{ form.address.id_for_label }}">Address</label>
          {{ form.address }}
          <div class="form-text">Full address with street, city, zip</div>
          {% if form.address.errors %}
            <div class="text-danger">{{ form.address.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="{{ form.medical_history.id_for_label }}">Medical History</label>
          {{ form.medical_history }}
          <div class="form-text">Allergies, chronic conditions, past surgeries, etc.</div>
          {% if form.medical_history.errors %}
            <div class="text-danger">{{ form.medical_history.errors }}</div>
          {% endif %}
        </div>
        <div class="form-group">
          <label class="form-label" for="{{ form.blood_group.id_for_label }}">Blood Group</label>
          {{ form.blood_group }}
          {% if form.blood_group.errors %}
            <div class="text-danger">{{ form.blood_group.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label required" for="{{ form.gender.id_for_label }}">Gender</label>
          {{ form.gender }}
          {% if form.gender.errors %}
            <div class="text-danger">{{ form.gender.errors }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="photo-section-divided">
        <div class="photo-col-upload">
          <label class="form-label" for="id_photo">Photo (optional)</label>
          <input type="file" id="id_photo" name="photo" accept="image/png, image/jpeg" class="form-control" />
          {% if form.photo.errors %}
            <div class="text-danger">{{ form.photo.errors }}</div>
          {% endif %}
          <div id="photo-filename-debug" class="form-text">No file selected</div>
        </div>
        <div class="photo-col-preview">
          <img id="photo-preview" src="{% if form.instance and form.instance.photo %}{{ form.instance.photo.url }}{% else %}{% static 'img/no-photo.png' %}{% endif %}" alt="Preview" class="{% if not form.instance or not form.instance.photo %}photo-preview-hidden{% endif %}" />
          <div style="margin-top:8px;" class="form-text">Allowed: JPG or PNG, up to 2MB.</div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn-submit"> Save Patient</button>
        <a href="{% url 'patient_list' %}" class="btn-cancel">Cancel</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function() {
  function ready(fn) {
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(fn, 0);
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  }
  
  ready(function() {
    const usernameInput = document.getElementById('id_username');
    const usernameStatus = document.getElementById('usernameStatus');
    let checkTimeout;
    
    // Username live check
    if (usernameInput && usernameStatus) {
      usernameInput.addEventListener('input', function() {
        clearTimeout(checkTimeout);
        const username = this.value.trim();
        
        if (username.length === 0) {
          usernameStatus.innerHTML = '';
          usernameInput.style.borderColor = '#e2e8f0';
          return;
        }
        
        usernameStatus.innerHTML = '<span class="username-checking">üîç Checking...</span>';
        usernameInput.style.borderColor = '#e2e8f0';
        
        if (username.length < 3) {
          usernameStatus.innerHTML = '<span class="text-warning">3+ characters required</span>';
          return;
        }
        
        checkTimeout = setTimeout(function() {
          fetch('/api/check-username/?username=' + encodeURIComponent(username))
            .then(function(response) { return response.json(); })
            .then(function(data) {
              if (data.available) {
                usernameStatus.innerHTML = '<span class="username-available">‚úÖ Available!</span>';
                usernameInput.style.borderColor = '#10b981';
              } else {
                usernameStatus.innerHTML = '<span class="username-taken">‚ùå Taken</span><br><small>Try: <strong>' + data.suggestion + '</strong></small>';
                usernameInput.style.borderColor = '#ef4444';
              }
            })
            .catch(function() {
              usernameStatus.innerHTML = '<span class="username-checking">‚ö†Ô∏è Check failed</span>';
            });
        }, 500);
      });
    }
    
    // Photo preview
    const previewImage = document.getElementById('photo-preview');
    const photoInput = document.getElementById('id_photo');
    
    if (photoInput && previewImage) {
      photoInput.addEventListener('change', function() {
        const file = this.files && this.files[0];
        const debug = document.getElementById('photo-filename-debug');
        
        if (!file) {
          previewImage.classList.add('photo-preview-hidden');
          if (debug) debug.textContent = 'No file selected';
          return;
        }
        
        if (file.size > 2 * 1024 * 1024) {
          alert('File too large. Maximum 2MB allowed.');
          photoInput.value = '';
          previewImage.classList.add('photo-preview-hidden');
          if (debug) debug.textContent = 'No file selected';
          return;
        }
        
        if (!['image/png', 'image/jpeg'].includes(file.type)) {
          alert('Please select a JPG or PNG image only');
          photoInput.value = '';
          previewImage.classList.add('photo-preview-hidden');
          if (debug) debug.textContent = 'No file selected';
          return;
        }
        
        if (debug) debug.textContent = '‚úì Selected: ' + file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewImage.classList.remove('photo-preview-hidden');
        };
        reader.readAsDataURL(file);
      });
    }
    
    // DOB max date = today
    const dobInput = document.getElementById('id_date_of_birth');
    if (dobInput) {
      const today = new Date().toISOString().split('T')[0];
      dobInput.setAttribute('max', today);
    }
    
    // Add form-control class
    document.querySelectorAll('.patient-form input, .patient-form textarea, .patient-form select').forEach(function(el) {
      if (!el.classList.contains('form-control')) el.classList.add('form-control');
    });
  });
})();
</script>
{% endblock %}
