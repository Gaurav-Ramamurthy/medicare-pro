{% extends "core/base.html" %}

{% block title %}Create User — MediCare Pro{% endblock %}

{% block extra_css %}
<style>
.create-user-wrapper {
  max-width: 900px;
  margin: 0 auto;
  padding: 24px 18px;
}

.create-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.create-header h1 {
  font-size: 1.6rem;
  font-weight: 700;
  color: #0f172a;
  margin: 0;
}

.create-subtitle {
  font-size: 0.95rem;
  color: #64748b;
}

.btn-outline-custom {
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  text-decoration: none;
  border: 2px solid #cbd5e1;
  color: #64748b;
  background: #fff;
  transition: all 0.2s;
}

.btn-outline-custom:hover {
  background: #f8fafc;
  border-color: #94a3b8;
}

/* Card */
.create-card {
  background: #ffffff;
  border-radius: 14px;
  box-shadow: 0 8px 22px rgba(15,23,42,0.08);
  padding: 22px 22px 24px;
}

/* Layout */
.form-row {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 16px 18px;
  margin-top: 10px;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-field label {
  font-size: 0.9rem;
  font-weight: 600;
  color: #475569;
}

.form-field label .required {
  color: #dc2626;
  margin-left: 2px;
}

.form-field input,
.form-field select,
.form-field textarea {
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  padding: 9px 10px;
  font-size: 0.95rem;
  color: #0f172a;
  outline: none;
  transition: all 0.2s;
  width: 100%;
}

.form-field input:focus,
.form-field select:focus,
.form-field textarea:focus {
  border-color: #0ea5e9;
  box-shadow: 0 0 0 3px rgba(14,165,233,0.15);
}

/* Password wrapper */
.password-wrapper {
  position: relative;
  width: 100%;
}

.password-wrapper input {
  padding-right: 40px;
}

#togglePassword {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  user-select: none;
}

#togglePassword.active path,
#togglePassword.active circle {
  stroke: #0f172a;
}

/* Section title */
.section-title {
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-weight: 700;
  color: #94a3b8;
  margin: 18px 0 4px;
}

/* Photo preview */
.photo-wrapper {
  display: flex;
  gap: 12px;
  align-items: center;
}

.photo-preview {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  border: 2px dashed #cbd5e1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #94a3b8;
  font-size: 0.75rem;
  overflow: hidden;
  background: #f8fafc;
}

.photo-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Hide sections until role selected */
#userFieldsWrapper {
  display: none;
}

/* CREATE BUTTON (cyan like search) */
.btn-primary-create {
  background: #00bcd4;
  color: #fff;
  border-radius: 3px;
  padding: 11px 32px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  font-size: 0.95rem;
  box-shadow: 0 16px 30px rgba(0,188,212,0.35);
  transition: all 0.2s;
}

.btn-primary-create:hover {
  background: #00acc1;
  box-shadow: 0 10px 22px rgba(0,188,212,0.25);
}

.btn-primary-create:disabled {
  background: #94a3b8;
  cursor: not-allowed;
  box-shadow: none;
}

.actions-row {
  margin-top: 22px;
  display: flex;
  justify-content: flex-end;
}

/* Small error text */
.field-error {
  font-size: 0.8rem;
  color: #dc2626;
  margin-top: 2px;
}

/* Mobile */
@media (max-width: 768px) {
  .create-user-wrapper {
    padding: 18px 12px;
  }
  .form-row {
    grid-template-columns: 1fr;
  }
  .create-card {
    padding: 18px 16px 20px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="create-user-wrapper">
  <div class="create-header">
    <div>
      <h1>Create User</h1>
      <div class="create-subtitle">
        Select a staff role (Doctor / Receptionist), then fill in required details and upload a profile photo.
      </div>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn-outline-custom">← Dashboard</a>
  </div>

  <div class="create-card">
    <form method="post" enctype="multipart/form-data" id="createUserForm" novalidate>
      {% csrf_token %}

      <!-- ROLE DROPDOWN (patient removed) -->
      <div class="form-field">
        <label for="{{ form.role.id_for_label }}">Role <span class="required">*</span></label>
        <select id="{{ form.role.id_for_label }}" name="{{ form.role.html_name }}" required>
          <option value="">Select role…</option>
          {% for value, label in form.role.field.choices %}
            {% if value != 'patient' %}
              <option value="{{ value }}" {% if form.role.value == value %}selected{% endif %}>
                {{ label }}
              </option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <!-- All other fields wrapper (hidden until role chosen) -->
      <div id="userFieldsWrapper">
        <div class="section-title">Account details</div>
        <div class="form-row">
          <div class="form-field">
            <label for="id_username">Username <span class="required">*</span></label>
            <input type="text" name="username" id="id_username" required
                   placeholder="Enter username">
          </div>

          <div class="form-field">
            <label for="id_email">Email</label>
            <input type="email" name="email" id="id_email"
                   placeholder="user@example.com">
          </div>

          <div class="form-field">
            <label for="id_password">Password <span class="required">*</span></label>
            <div class="password-wrapper">
              <input type="password" name="password" id="id_password" required
                     placeholder="Enter password">
              <svg id="togglePassword" xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                   viewBox="0 0 24 24" fill="none" stroke="#6b7280"
                   stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </div>
          </div>

          <div class="form-field">
            <label for="id_first_name">First name <span class="required">*</span></label>
            <input type="text" name="first_name" id="id_first_name" required
                   placeholder="First name">
          </div>

          <div class="form-field">
            <label for="id_last_name">Last name <span class="required">*</span></label>
            <input type="text" name="last_name" id="id_last_name" required
                   placeholder="Last name">
          </div>

          <div class="form-field">
            <label>Profile photo</label>
            <div class="photo-wrapper">
              <div class="photo-preview" id="photoPreview">
                <span>Preview</span>
              </div>
              <input type="file" name="profile_photo" id="id_profile_photo" accept="image/*">
            </div>
          </div>
        </div>

        <div class="section-title">Contact details</div>
        <div class="form-row">
          <div class="form-field">
            <label for="id_phone">Phone <span class="required">*</span></label>
            <input type="text" name="phone" id="id_phone" required
                   placeholder="Contact number">
          </div>
          <div class="form-field">
            <label for="id_address">Address</label>
            <textarea name="address" id="id_address" rows="2" placeholder="Address"></textarea>
          </div>
        </div>

        <!-- Doctor-only fields -->
        <div id="doctorExtraFields" style="display:none;">
          <div class="section-title">Doctor details</div>
          <div class="form-row">
            <div class="form-field">
              <label for="id_specialization">Specialization <span class="required">*</span></label>
              <input type="text" name="specialization" id="id_specialization"
                     placeholder="e.g. Cardiologist">
            </div>

            <div class="form-field">
              <label for="id_registration_number">
                Registration number <span class="required">*</span> (e.g. AAA/2024/12345)
              </label>
              <input type="text"
                     name="registration_number"
                     id="id_registration_number"
                     placeholder="AAA/YYYY/12345"
                     maxlength="15">
              <span class="field-error" id="regError" style="display:none;">
                Invalid format. Use STATECODE/YYYY/12345 (e.g. AAA/2024/12345).
              </span>
            </div>

            <div class="form-field">
              <label for="id_experience_years">Experience (years) <span class="required">*</span></label>
              <input type="number" min="0" name="experience_years" id="id_experience_years"
                     placeholder="e.g. 5">
            </div>

            <div class="form-field">
              <label for="id_doctor_notes">Doctor notes</label>
              <textarea name="doctor_notes" id="id_doctor_notes" rows="2"
                        placeholder="Availability, timings, etc."></textarea>
            </div>
          </div>
        </div>

        <div class="actions-row">
          <button type="submit" class="btn-primary-create" id="submitBtn">Create User</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  /* Password toggle */
  const togglePassword = document.querySelector('#togglePassword');
  const passwordField = document.querySelector('#id_password');
  if (togglePassword && passwordField) {
    togglePassword.addEventListener('click', function () {
      const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordField.setAttribute('type', type);
      togglePassword.classList.toggle('active');
    });
  }

  /* Role select: show fields + doctor extras + set required */
  const roleField = document.getElementById('{{ form.role.id_for_label }}');
  const wrapper = document.getElementById('userFieldsWrapper');
  const doctorExtra = document.getElementById('doctorExtraFields');
  
  const specializationField = document.getElementById('id_specialization');
  const regNumberField = document.getElementById('id_registration_number');
  const experienceField = document.getElementById('id_experience_years');

  function updateRoleUI() {
    if (!roleField || !wrapper) return;
    const role = roleField.value;
    if (!role) {
      wrapper.style.display = 'none';
      if (doctorExtra) doctorExtra.style.display = 'none';
      // remove required from doctor fields
      if (specializationField) specializationField.removeAttribute('required');
      if (regNumberField) regNumberField.removeAttribute('required');
      if (experienceField) experienceField.removeAttribute('required');
      return;
    }
    wrapper.style.display = 'block';
    if (doctorExtra) {
      if (role === 'doctor') {
        doctorExtra.style.display = 'block';
        // make doctor fields required
        if (specializationField) specializationField.setAttribute('required', 'required');
        if (regNumberField) regNumberField.setAttribute('required', 'required');
        if (experienceField) experienceField.setAttribute('required', 'required');
      } else {
        doctorExtra.style.display = 'none';
        // remove required
        if (specializationField) specializationField.removeAttribute('required');
        if (regNumberField) regNumberField.removeAttribute('required');
        if (experienceField) experienceField.removeAttribute('required');
      }
    }
  }

  if (roleField) {
    roleField.addEventListener('change', updateRoleUI);
    updateRoleUI();
  }

  /* Photo preview */
  const fileInput = document.getElementById('id_profile_photo');
  const previewBox = document.getElementById('photoPreview');

  if (fileInput && previewBox) {
    fileInput.addEventListener('change', function () {
      const file = this.files && this.files[0];
      if (!file) {
        previewBox.innerHTML = '<span>Preview</span>';
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        previewBox.innerHTML = '<img src="' + e.target.result + '" alt="Profile preview">';
      };
      reader.readAsDataURL(file);
    });
  }

  /* Registration number validation: STATE/YEAR/NUMBER like AAA/2024/12345 */
  const regInput = document.getElementById('id_registration_number');
  const regError = document.getElementById('regError');
  const form = document.getElementById('createUserForm');
  const regPattern = /^[A-Z]{2,4}\/\d{4}\/\d{4,5}$/;  // e.g. AAA/2024/12345

  function validateReg() {
    if (!regInput) return true;
    const value = regInput.value.trim();
    
    // if doctor role and field is required
    if (regInput.hasAttribute('required') && !value) {
      regError.textContent = 'Registration number is required for doctors.';
      regError.style.display = 'block';
      return false;
    }
    
    if (!value) {
      regError.style.display = 'none';
      return true;
    }
    
    if (value.length > 15) {
      regError.textContent = 'Registration number too long (max 15 characters).';
      regError.style.display = 'block';
      return false;
    }
    
    if (!regPattern.test(value)) {
      regError.textContent = 'Invalid format. Use STATECODE/YYYY/12345 (e.g. AAA/2024/12345).';
      regError.style.display = 'block';
      return false;
    }
    
    regError.style.display = 'none';
    return true;
  }

  if (regInput) {
    regInput.addEventListener('input', validateReg);
    regInput.addEventListener('blur', validateReg);
  }

  /* Form submit validation */
  if (form) {
    form.addEventListener('submit', function (e) {
      // First check HTML5 required fields
      if (!form.checkValidity()) {
        e.preventDefault();
        // Show browser validation messages
        form.reportValidity();
        return false;
      }
      
      // Then custom registration validation
      if (!validateReg()) {
        e.preventDefault();
        if (regInput) regInput.focus();
        return false;
      }
    });
  }
});
</script>
{% endblock %}
