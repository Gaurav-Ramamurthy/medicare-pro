{% extends "core/base.html" %}
{% block title %}{% if form.instance and form.instance.pk %}Edit{% else %}New{% endif %} Appointment{% endblock %}

{% block extra_css %}
<style>
/* ========================================
   MODERN APPOINTMENT FORM STYLES
   ======================================== */

.form-wrapper {
  max-width: 880px;
  margin: 0 auto;
  padding: 24px 18px;
}

/* Page Header */
.form-page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  gap: 16px;
  flex-wrap: wrap;
}

.form-page-header h1 {
  font-size: 1.8rem;
  font-weight: 700;
  color: #0f172a;
  margin: 0;
}

.btn-back {
  padding: 8px 16px;
  background: #fff;
  color: #64748b;
  border: 2px solid #cbd5e1;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  text-decoration: none;
  transition: all 0.2s;
  display: inline-block;
}

.btn-back:hover {
  background: #f8fafc;
  border-color: #94a3b8;
  color: #475569;
}

/* Form Card */
.form-card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  padding: 32px;
  margin-bottom: 24px;
}

/* Form Elements */
.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-label {
  font-weight: 600;
  font-size: 0.9rem;
  color: #334155;
  margin-bottom: 8px;
  display: block;
}

.required-star {
  color: #dc2626;
}

.form-control {
  width: 100%;
  padding: 11px 14px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 0.95rem;
  color: #334155;
  background: #fff;
  transition: all 0.2s;
  font-family: inherit;
}

.form-control:focus {
  outline: none;
  border-color: #00bcd4;
  box-shadow: 0 0 0 3px rgba(0,188,212,0.1);
}

.form-control:disabled {
  background: #f8fafc;
  color: #94a3b8;
  cursor: not-allowed;
}

/* Select Styling */
select.form-control {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 40px;
}

/* Textarea */
textarea.form-control {
  min-height: 100px;
  resize: vertical;
  font-family: inherit;
}

/* Form Help Text */
.form-text {
  font-size: 0.85rem;
  color: #64748b;
  margin-top: 6px;
}

/* Error Messages */
.text-danger {
  color: #dc2626;
  font-size: 0.85rem;
  margin-top: 6px;
  font-weight: 500;
}

.alert-danger {
  background: #fee2e2;
  color: #dc2626;
  border: 2px solid #fca5a5;
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 20px;
  font-size: 0.9rem;
}

/* Form Actions */
.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 28px;
  flex-wrap: wrap;
}

.btn-primary {
  padding: 11px 24px;
  background: #00bcd4;
  color: #fff;
  border: 2px solid #00bcd4;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary:hover {
  background: #00acc1;
  border-color: #00acc1;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,188,212,0.3);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  padding: 11px 24px;
  background: #fff;
  color: #64748b;
  border: 2px solid #cbd5e1;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.95rem;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-block;
}

.btn-secondary:hover {
  background: #f8fafc;
  border-color: #94a3b8;
  color: #475569;
}

/* Footer */
.form-footer {
  text-align: center;
  color: #94a3b8;
  font-size: 0.85rem;
  margin-top: 32px;
}

/* Input Date/Time Specific Styling */
input[type="date"].form-control,
input[type="time"].form-control {
  cursor: pointer;
}

input[type="date"].form-control::-webkit-calendar-picker-indicator,
input[type="time"].form-control::-webkit-calendar-picker-indicator {
  cursor: pointer;
  filter: opacity(0.6);
}

input[type="date"].form-control::-webkit-calendar-picker-indicator:hover,
input[type="time"].form-control::-webkit-calendar-picker-indicator:hover {
  filter: opacity(1);
}

/* ========================================
   MOBILE RESPONSIVE
   ======================================== */

@media (max-width: 768px) {
  .form-wrapper {
    padding: 16px 12px;
  }

  .form-card {
    padding: 20px;
  }

  .form-page-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .form-row {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .form-actions {
    flex-direction: column;
    width: 100%;
  }

  .btn-primary,
  .btn-secondary {
    width: 100%;
    text-align: center;
  }

  .form-page-header h1 {
    font-size: 1.5rem;
  }
}

/* ========================================
   LOADING STATE
   ======================================== */

.btn-primary:disabled {
  background: #cbd5e1;
  border-color: #cbd5e1;
  cursor: not-allowed;
  opacity: 0.7;
}

.btn-primary.loading {
  position: relative;
  color: transparent;
}

.btn-primary.loading::after {
  content: "";
  position: absolute;
  width: 16px;
  height: 16px;
  top: 50%;
  left: 50%;
  margin-left: -8px;
  margin-top: -8px;
  border: 2px solid #fff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spinner 0.6s linear infinite;
}

@keyframes spinner {
  to {
    transform: rotate(360deg);
  }
}
/* Single-box searchable select (combo) */
.combo-wrapper {
  position: relative;
}

.combo-input {
  cursor: text;
}

.combo-list {
  position: absolute;
  left: 0;
  right: 0;
  top: 100%;
  margin-top: 4px;
  max-height: 220px;
  overflow-y: auto;
  list-style: none;
  padding: 4px 0;
  background: #fff;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 8px 20px rgba(15,23,42,0.12);
  z-index: 50;
  display: none;
}

.combo-list.show {
  display: block;
}

.combo-list-item {
  padding: 8px 12px;
  font-size: 0.9rem;
  color: #0f172a;
  cursor: pointer;
}

.combo-list-item:hover,
.combo-list-item.active {
  background: #e0f2fe;
  color: #0369a1;
}

</style>
{% endblock %}

{% block content %}
<div class="form-wrapper">

  <div class="form-page-header">
    <h1>{% if form.instance and form.instance.pk %}Edit{% else %}New{% endif %} Appointment</h1>
    {% if request.user.is_superuser or request.user.role == 'admin' %}
      <a class="btn-back" href="{% url 'admin_dashboard' %}">← Back to Dashboard</a>
    {% elif request.user.role == 'doctor' %}
      <a class="btn-back" href="{% url 'doctor_dashboard' %}">← Back to Dashboard</a>
    {% elif request.user.role == 'reception' %}
      <a class="btn-back" href="{% url 'reception_dashboard' %}">← Back to Dashboard</a>
    {% elif request.user.role == 'patient' %}
      <a class="btn-back" href="{% url 'patient_dashboard' %}">← Back to Dashboard</a>
    {% else %}
      <a class="btn-back" href="{% url 'dashboard' %}">← Back to Dashboard</a>
    {% endif %}
  </div>

  <div class="form-card">
    <form method="post" novalidate class="appointment-form" id="appointment-form">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert-danger" id="non-field-errors">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="{{ form.patient.id_for_label }}">
            {{ form.patient.label }} <span class="required-star">*</span>
          </label>


          <!-- Searchable single-box control for Patient -->
          <div class="combo-wrapper" data-select-name="patient">
            <input type="text"
                   class="form-control combo-input"
                   id="patient-combo"
                   placeholder="Search or select patient…"
                   autocomplete="off">
            <ul class="combo-list" id="patient-combo-list"></ul>
          </div>
          <!-- Real select kept hidden for Django form binding -->
          <div style="display:none;">
            {{ form.patient }}
          </div>

          {% if form.patient.help_text %}
            <div class="form-text">{{ form.patient.help_text }}</div>
          {% endif %}
          {% if form.patient.errors %}
            <div class="text-danger">{{ form.patient.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.doctor.id_for_label }}">{{ form.doctor.label }} <span class="required-star">*</span></label>

          <!-- Searchable single-box control for Doctor -->
          <div class="combo-wrapper" data-select-name="doctor">
            <input type="text"
                   class="form-control combo-input"
                   id="doctor-combo"
                   placeholder="Search or select doctor…"
                   autocomplete="off">
            <ul class="combo-list" id="doctor-combo-list"></ul>
          </div>
          <!-- Real select kept hidden for Django form binding -->
          <div style="display:none;">
            {{ form.doctor }}
          </div>

          {% if form.doctor.errors %}
            <div class="text-danger">{{ form.doctor.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="{{ form.scheduled_date.id_for_label }}">Date <span class="required-star">*</span></label>
          {{ form.scheduled_date }}
          {% if form.scheduled_date.errors %}
            <div class="text-danger">{{ form.scheduled_date.errors }}</div>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label" for="{{ form.scheduled_time_field.id_for_label }}">Time <span class="required-star">*</span></label>
          {{ form.scheduled_time_field }}
          {% if form.scheduled_time_field.errors %}
            <div class="text-danger">{{ form.scheduled_time_field.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label" for="{{ form.reason.id_for_label }}">Reason</label>
          {{ form.reason }}
          {% if form.reason.errors %}
            <div class="text-danger">{{ form.reason.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
          {{ form.status }}
          {% if form.status.errors %}
            <div class="text-danger">{{ form.status.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary" id="submitBtn">
          {% if form.instance and form.instance.pk %}Update Appointment{% else %}Save Appointment{% endif %}
        </button>
        <a class="btn-secondary" href="{% url 'appointment_list' %}">Cancel</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
(function() {
  // Ensure form-control on all fields
  document.querySelectorAll('.appointment-form input, .appointment-form textarea, .appointment-form select').forEach(function(el){
    if (!el.classList.contains('form-control')) el.classList.add('form-control');
  });

  // -------------------------------
  // Generic combo (searchable select) builder
  // -------------------------------
  function setupCombo(inputId, listId, selectName) {
    const inputEl = document.getElementById(inputId);
    const listEl = document.getElementById(listId);
    const selectEl = document.querySelector('.appointment-form select[name="' + selectName + '"]');
    if (!inputEl || !listEl || !selectEl) return;

    const allOptions = Array.from(selectEl.options);
    let filteredOptions = allOptions.slice();
    let activeIndex = -1;

    // Helper to refresh list UI
    function renderList() {
      listEl.innerHTML = '';
      if (!filteredOptions.length) {
        listEl.classList.remove('show');
        return;
      }
      filteredOptions.forEach(function(opt, idx) {
        const li = document.createElement('li');
        li.textContent = opt.text;
        li.dataset.value = opt.value;
        li.className = 'combo-list-item' + (idx === activeIndex ? ' active' : '');
        li.addEventListener('mousedown', function(e) {
          e.preventDefault(); // prevent blurring input
          selectValue(opt);
        });
        listEl.appendChild(li);
      });
      listEl.classList.add('show');
    }

    // Set value into real select + input
    function selectValue(opt) {
      selectEl.value = opt.value;
      // Only show text if value is not empty
      if (opt.value) {
        inputEl.value = opt.text;
      } else {
        inputEl.value = ''; // clear input so placeholder shows
      }
      listEl.classList.remove('show');
      activeIndex = -1;
      // Optional toast
      if (opt.value) {
        if (selectName === 'patient') {
          Toast.success('Patient selected: ' + opt.text);
        } else if (selectName === 'doctor') {
          Toast.success('Doctor selected: ' + opt.text);
        }
      }
    }

    // Initialize input from current select value
    const initialOpt = allOptions.find(o => o.value === selectEl.value);
    if (initialOpt && initialOpt.value) {
      inputEl.value = initialOpt.text;
    } else {
      inputEl.value = ''; // keep empty so placeholder shows
    }

    // Filter as user types
    inputEl.addEventListener('input', function() {
      const term = this.value.toLowerCase().trim();
      filteredOptions = allOptions.filter(function(opt) {
        return !term || (opt.text || '').toLowerCase().includes(term);
      });
      activeIndex = filteredOptions.length ? 0 : -1;
      renderList();
    });

    // Show all on focus
    inputEl.addEventListener('focus', function() {
      filteredOptions = allOptions.slice();
      activeIndex = filteredOptions.length ? 0 : -1;
      renderList();
    });

    // Keyboard navigation
    inputEl.addEventListener('keydown', function(e) {
      if (!listEl.classList.contains('show')) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (filteredOptions.length) {
          activeIndex = (activeIndex + 1) % filteredOptions.length;
          renderList();
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (filteredOptions.length) {
          activeIndex = (activeIndex - 1 + filteredOptions.length) % filteredOptions.length;
          renderList();
        }
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (filteredOptions[activeIndex]) {
          selectValue(filteredOptions[activeIndex]);
        }
      } else if (e.key === 'Escape') {
        listEl.classList.remove('show');
      }
    });

    // Hide list when clicking outside
    document.addEventListener('click', function(e) {
      if (!inputEl.contains(e.target) && !listEl.contains(e.target)) {
        listEl.classList.remove('show');
      }
    });
  }

  // Build combos for patient and doctor
  setupCombo('patient-combo', 'patient-combo-list', 'patient');
  setupCombo('doctor-combo',  'doctor-combo-list',  'doctor');

  // -------------------------------
  // Date/time limit logic (unchanged)
  // -------------------------------
  function pad(n){ return n < 10 ? '0' + n : String(n); }
  const dateInput = document.querySelector('[name="scheduled_date"]');
  const timeInput = document.querySelector('[name="scheduled_time_field"]');
  if (!dateInput) return;

  function setMinDateToToday() {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = pad(now.getMonth() + 1);
    const dd = pad(now.getDate());
    const minDate = `${yyyy}-${mm}-${dd}`;
    dateInput.setAttribute('min', minDate);
    if (dateInput.value && dateInput.value < minDate) {
      dateInput.value = minDate;
      Toast.warning('Date cannot be in the past. Set to today.');
      setMinTimeIfNeeded();
    }
  }

  function setMinTimeIfNeeded() {
    if (!timeInput) return;
    const selected = dateInput.value;
    if (!selected) {
      timeInput.removeAttribute('min');
      return;
    }
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = pad(today.getMonth() + 1);
    const dd = pad(today.getDate());
    const todayStr = `${yyyy}-${mm}-${dd}`;

    if (selected === todayStr) {
      const next = new Date(Date.now() + 60000);
      const hh = pad(next.getHours());
      const mi = pad(next.getMinutes());
      timeInput.setAttribute('min', `${hh}:${mi}`);
      if (timeInput.value && timeInput.value < `${hh}:${mi}`) {
        timeInput.value = `${hh}:${mi}`;
        Toast.info('Time adjusted to nearest available slot.');
      }
    } else {
      timeInput.removeAttribute('min');
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    setMinDateToToday();
    setMinTimeIfNeeded();
  });

  dateInput.addEventListener('change', function(){
    setMinTimeIfNeeded();
    if (dateInput.value) {
      Toast.success('Date selected: ' + dateInput.value);
    }
  });

  if (timeInput) {
    timeInput.addEventListener('change', function(){
      if (timeInput.value) {
        Toast.success('Time selected: ' + timeInput.value);
      }
    });

    timeInput.addEventListener('blur', function(){
      const min = timeInput.getAttribute('min');
      if (min && timeInput.value && timeInput.value < min) {
        timeInput.value = min;
        Toast.warning('Time adjusted to minimum allowed: ' + min);
      }
    });
  }

  // -------------------------------
  // Form validation (unchanged)
  // -------------------------------
  var appointmentForm = document.getElementById('appointment-form');
  var submitBtn = document.getElementById('submitBtn');
  
  if (appointmentForm) {
    appointmentForm.addEventListener('submit', function(e) {
      var errors = [];

      var patient = document.querySelector('[name="patient"]');
      var doctor = document.querySelector('[name="doctor"]');
      var date = document.querySelector('[name="scheduled_date"]');
      var time = document.querySelector('[name="scheduled_time_field"]');
      var reason = document.querySelector('[name="reason"]');
      var status = document.querySelector('[name="status"]');

      if (!patient || !patient.value) {
        errors.push('Please select a patient');
      }
      if (!doctor || !doctor.value) {
        errors.push('Please select a doctor');
      }
      if (!date || !date.value) {
        errors.push('Please select an appointment date');
      } else {
        var selectedDate = new Date(date.value);
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        if (selectedDate < today) {
          errors.push('Appointment date cannot be in the past');
        }
      }
      if (!time || !time.value) {
        errors.push('Please select an appointment time');
      } else if (date && date.value) {
        var selectedDate2 = new Date(date.value);
        var today2 = new Date();
        today2.setHours(0, 0, 0, 0);
        if (selectedDate2.getTime() === today2.getTime()) {
          var now = new Date();
          var selectedTime = time.value.split(':');
          var selectedDateTime = new Date();
          selectedDateTime.setHours(parseInt(selectedTime[0]), parseInt(selectedTime[1]), 0, 0);
          if (selectedDateTime <= now) {
            errors.push('Appointment time must be in the future');
          }
        }
      }
      if (!reason || !reason.value.trim()) {
        errors.push('Please provide a reason for the appointment');
      } else if (reason.value.trim().length < 5) {
        errors.push('Reason must be at least 5 characters long');
      }
      if (!status || !status.value) {
        errors.push('Please select an appointment status');
      }

      if (errors.length > 0) {
        e.preventDefault();
        Toast.error(errors[0]);
        console.log('Appointment form validation errors:', errors);
        return false;
      }

      if (submitBtn) {
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
      }

      Toast.info('{% if form.instance and form.instance.pk %}Updating appointment...{% else %}Booking appointment...{% endif %}');
    });
  }
})();
</script>
{% endblock %}
