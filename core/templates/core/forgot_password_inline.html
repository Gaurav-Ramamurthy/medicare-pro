{% load static %}
<!doctype html>
<html lang="en">
<head>
  
  <link rel="icon" type="image/png" href="{% static 'logo.png' %}">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forgot password â€” MediCare Pro</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <style>
    .panel { max-width:560px; margin:40px auto; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(15,23,42,.06); overflow:hidden; }
    .brand-top { background:linear-gradient(90deg, #00bcd4 0%, #00acc1 100%); color:#fff; padding:12px; font-weight:800; text-align:center; }
    .panel-body { padding:20px; }
    .muted { color:#64748b; }
    label { display:block; margin-bottom:6px; font-weight:700; color:#334155; }
    .input { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6eef0; font-size:1rem; box-sizing:border-box; }
    .btn { display:inline-block; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; border:none; }
    .btn-primary { background: #00bcd4; color: white;}
    .btn-primary:hover {
      background: #00acc1; 
      transform: translateY(-2px); 
      box-shadow: 0 8px 20px rgba(0,188,212,0.3);
    }
    .btn-ghost { background:transparent; color:#0f172a; border:1px solid #e6eef0; padding:8px 12px; border-radius:8px; }
    .inline-error { color:#b91c1c; font-size:0.95rem; margin-top:6px; display:none; }
    .small-link { background:transparent; border:none; color: #0ea5a4; text-decoration:none; cursor:pointer; padding:0; font-size:0.95rem; font-weight:500; }
    .small-link:hover {text-decoration: underline !important;}
    .row { margin-bottom:12px; }
    .hidden { display:none !important; }
    
    /* Password Reset Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 24px;
      color: #64748b;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: #f1f5f9;
      color: #0f172a;
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #0f172a;
      margin: 0 0 8px 0;
    }
    .modal-subtitle {
      color: #64748b;
      margin: 0 0 24px 0;
      font-size: 0.9rem;
    }
    .modal-row {
      margin-bottom: 20px;
    }
    
    @media (max-width:520px) { 
      .panel { margin:20px; padding:0; }
      .modal-content { padding: 24px; }
    }

    /* Toast styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 11000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 400px;
    }
    .toast {
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-weight: 600;
      min-width: 250px;
      max-width: 400px;
      cursor: pointer;
      opacity: 1;
      transform: translateX(0);
      transition: all 0.4s ease;
    }
  </style>
</head>
<body>

  <div class="panel" role="main" aria-labelledby="forgot-heading">
    <div class="brand-top">MediCare Pro</div>

    <div class="panel-body">
      <h2 id="forgot-heading">Forgot password</h2>
      <p class="muted">Enter the email registered to your account â€” we'll send a 6-digit code there.</p>

      <!-- no inline notice; toasts will handle feedback -->

      <form id="fp-form" method="post" action="{% url 'forgot-password' %}">
        {% csrf_token %}

        <div class="row">
          <label for="id_email">Email</label>
          <input id="id_email" name="email" type="email" class="input" placeholder="you@example.com" required autocomplete="email">
          <div id="email-error" class="inline-error" aria-live="polite"></div>
        </div>

        <div id="otp-row" class="row hidden" aria-hidden="true">
          <label for="id_code">Enter 6-digit code</label>
          <input id="id_code" name="code" type="text" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" class="input" placeholder="123456" autocomplete="one-time-code">
          <div id="code-error" class="inline-error" aria-live="polite"></div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <button id="primary-btn" type="button" class="btn btn-primary" style="flex:1;">
            Send code
          </button>

          <button id="resend-btn" type="button" class="btn-ghost hidden" aria-hidden="true">Resend code</button>

          <button id="verify-cancel" type="button" class="btn-ghost hidden" aria-hidden="true">Cancel</button>
        </div>

        <div style="margin-top:12px;">
          <a href="{% url 'login' %}" class="small-link">Back to sign in</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Password Reset Modal -->
  <div id="password-modal" class="modal-overlay">
    <div class="modal-content">
      <button type="button" class="modal-close" id="close-modal">Ã—</button>
      
      <h2 class="modal-title">Set new password</h2>
      <p class="modal-subtitle">Create a strong password for your account</p>

      <div id="modal-notice" class="inline-error" style="display:none;"></div>

      <form id="password-form" method="post" action="{% url 'password-manage' %}">
        {% csrf_token %}
        
        <div class="modal-row">
          <label for="id_new_password1">New password</label>
          <input type="password" id="id_new_password1" name="new_password1" class="input" required minlength="8">
          <div id="pw1-error" class="inline-error"></div>
          <small class="muted" style="display:block;margin-top:4px;">Use 8+ characters</small>
        </div>

        <div class="modal-row">
          <label for="id_new_password2">Confirm new password</label>
          <input type="password" id="id_new_password2" name="new_password2" class="input" required>
          <div id="pw2-error" class="inline-error"></div>
        </div>

        <button type="submit" class="btn btn-primary">ðŸ”‘ Set Password</button>
      </form>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="toast-container"></div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length+1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* Toast helper */
const Toast = {
  container: document.getElementById('toast-container'),
  show(message, type='info', duration=5000) {
    if (!this.container) return;
    const colors = {
      success:'#10b981',
      error:'#ef4444',
      warning:'#f59e0b',
      info:'#3b82f6',
      danger:'#ef4444'
    };
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.background = colors[type] || colors.info;
    toast.textContent = message;
    toast.onclick = () => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(()=>toast.remove(), 400);
    };
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100%)';
      setTimeout(()=>toast.remove(), 400);
    }, duration);
    this.container.appendChild(toast);
  }
};

const form = document.getElementById('fp-form');
const emailInput = document.getElementById('id_email');
const codeInput = document.getElementById('id_code');
const otpRow = document.getElementById('otp-row');
const primaryBtn = document.getElementById('primary-btn');
const resendBtn = document.getElementById('resend-btn');
const verifyCancel = document.getElementById('verify-cancel');
const emailError = document.getElementById('email-error');
const codeError = document.getElementById('code-error');

const passwordModal = document.getElementById('password-modal');
const closeModalBtn = document.getElementById('close-modal');
const passwordForm = document.getElementById('password-form');
const modalNotice = document.getElementById('modal-notice');

let state = 'start';
let verifiedEmail = '';

function clearFieldErrors() {
  if (emailError) { emailError.style.display = 'none'; emailError.innerText = ''; }
  if (codeError) { codeError.style.display = 'none'; codeError.innerText = ''; }
}

function showOtpRow(show=true) {
  if (show) {
    otpRow.classList.remove('hidden'); 
    otpRow.setAttribute('aria-hidden','false');
    resendBtn.classList.remove('hidden'); 
    resendBtn.removeAttribute('aria-hidden');
    verifyCancel.classList.remove('hidden'); 
    verifyCancel.removeAttribute('aria-hidden');
    primaryBtn.textContent = 'Verify code';
    state = 'sent';
    setTimeout(()=> { if (codeInput) codeInput.focus(); }, 120);
  } else {
    otpRow.classList.add('hidden'); 
    otpRow.setAttribute('aria-hidden','true');
    resendBtn.classList.add('hidden'); 
    resendBtn.setAttribute('aria-hidden','true');
    verifyCancel.classList.add('hidden'); 
    verifyCancel.setAttribute('aria-hidden','true');
    primaryBtn.textContent = 'Send code';
    state = 'start';
    if (codeInput) codeInput.value = '';
  }
}

function showPasswordModal() {
  passwordModal.classList.add('show');
  setTimeout(() => {
    document.getElementById('id_new_password1').focus();
  }, 100);
}

function hidePasswordModal() {
  passwordModal.classList.remove('show');
  passwordForm.reset();
  modalNotice.style.display = 'none';
  modalNotice.innerText = '';
}

function flattenErrors(obj) {
  if (!obj) return '';
  if (typeof obj === 'string') return obj;
  if (Array.isArray(obj)) return obj.join(' ');
  if (typeof obj === 'object') {
    return Object.entries(obj).map(([k,v]) => `${k}: ${Array.isArray(v) ? v.join(' ') : v}`).join(' â€” ');
  }
  return String(obj);
}

async function ajaxPostJSON(url, data) {
  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken,
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify(data),
    credentials: 'same-origin'
  });

  const ct = (res.headers.get('content-type') || '').toLowerCase();

  if (ct.includes('application/json')) {
    const json = await res.json().catch(()=>({ ok:false, msg:'Invalid JSON' }));
    return { fallback: false, json, response: res };
  }

  if (res.ok) {
    return { fallback: false, json: { ok: true, msg: 'Success' }, response: res };
  }

  return { fallback: true, response: res };
}

// Primary button - Send/Verify
primaryBtn.addEventListener('click', async function(e){
  e.preventDefault();
  
  clearFieldErrors();

  const email = (emailInput.value || '').trim();
  if (!email) {
    emailError.innerText = 'Email is required';
    emailError.style.display = 'block';
    return;
  }

  if (state === 'start') {
    // SEND OTP
    primaryBtn.disabled = true;
    primaryBtn.innerText = 'Sendingâ€¦';
    
    try {
      const { fallback, json } = await ajaxPostJSON("{% url 'forgot-password' %}", { email });
      
      if (fallback) {
        form.submit();
        return;
      }
      
      if (json.ok) {
        verifiedEmail = email;
        Toast.show(json.msg || 'Code sent â€” check your email!', 'success');
        showOtpRow(true);
      } else {
        if (json.errors && json.errors.email) {
          emailError.innerText = (Array.isArray(json.errors.email) ? json.errors.email.join(' ') : json.errors.email);
          emailError.style.display = 'block';
        } else {
          Toast.show(json.msg || flattenErrors(json.errors) || 'Unable to send code', 'error');
        }
      }
    } catch (err) {
      Toast.show('Network error â€” try again', 'error');
    } finally {
      primaryBtn.disabled = false;
      primaryBtn.innerText = (state === 'sent') ? 'Verify code' : 'Send code';
    }

  } else if (state === 'sent') {
    // VERIFY OTP
    const code = (codeInput.value || '').trim();
    
    if (!/^[0-9]{6}$/.test(code)) {
      codeError.innerText = 'Please enter the 6-digit code';
      codeError.style.display = 'block';
      return;
    }

    primaryBtn.disabled = true;
    primaryBtn.innerText = 'Verifyingâ€¦';
    
    try {
      const { fallback, json } = await ajaxPostJSON("{% url 'verify-otp' %}", { email, code });
      
      if (fallback) {
        const f = document.createElement('form');
        f.method = 'POST';
        f.action = "{% url 'verify-otp' %}";
        const csrf = document.createElement('input'); 
        csrf.type='hidden'; 
        csrf.name='csrfmiddlewaretoken'; 
        csrf.value = csrftoken;
        f.appendChild(csrf);
        const eInput = document.createElement('input'); 
        eInput.type='hidden'; 
        eInput.name='email'; 
        eInput.value = email; 
        f.appendChild(eInput);
        const cInput = document.createElement('input'); 
        cInput.type='hidden'; 
        cInput.name='code'; 
        cInput.value = code; 
        f.appendChild(cInput);
        document.body.appendChild(f);
        f.submit();
        return;
      }
      
      if (json.ok) {
        Toast.show('Code verified! Now set your new password.', 'success');
        setTimeout(() => {
          showPasswordModal();
        }, 500);
      } else {
        if (json.errors && json.errors.code) {
          codeError.innerText = Array.isArray(json.errors.code) ? json.errors.code.join(' ') : json.errors.code;
          codeError.style.display = 'block';
        } else {
          Toast.show(json.msg || flattenErrors(json.errors) || 'Verification failed', 'error');
        }
      }
    } catch (err) {
      Toast.show('Network error â€” try again', 'error');
    } finally {
      primaryBtn.disabled = false;
      primaryBtn.innerText = 'Verify code';
    }
  }
});

// Password form submit
passwordForm.addEventListener('submit', async function(e){
  e.preventDefault();
  
  const pw1 = document.getElementById('id_new_password1').value;
  const pw2 = document.getElementById('id_new_password2').value;
  
  const pw1Error = document.getElementById('pw1-error');
  const pw2Error = document.getElementById('pw2-error');
  
  pw1Error.style.display = 'none';
  pw2Error.style.display = 'none';
  modalNotice.style.display = 'none';
  modalNotice.innerText = '';
  
  if (!pw1 || pw1.length < 8) {
    pw1Error.innerText = 'Password must be at least 8 characters';
    pw1Error.style.display = 'block';
    return;
  }
  
  if (pw1 !== pw2) {
    pw2Error.innerText = 'Passwords do not match';
    pw2Error.style.display = 'block';
    return;
  }
  
  const submitBtn = passwordForm.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.innerText = 'Setting password...';
  
  try {
    const formData = new FormData(passwordForm);
    const res = await fetch("{% url 'password-manage' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
      },
      body: formData,
      credentials: 'same-origin'
    });
    
    if (res.redirected || res.status === 302) {
      Toast.show('Password set successfully! Redirecting...', 'success');
      setTimeout(() => {
        window.location.href = "{% url 'login' %}";
      }, 1000);
    } else if (res.ok) {
      Toast.show('Password set successfully!', 'success');
      setTimeout(() => {
        window.location.href = "{% url 'login' %}";
      }, 800);
    } else {
      Toast.show('Failed to set password. Please try again.', 'error');
      modalNotice.style.display = 'block';
      modalNotice.innerText = 'Failed to set password. Please try again.';
    }
  } catch (err) {
    Toast.show('Network error. Please try again.', 'error');
    modalNotice.style.display = 'block';
    modalNotice.innerText = 'Network error. Please try again.';
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = 'ðŸ”‘ Set Password';
  }
});

// Resend button
resendBtn.addEventListener('click', async function(e){
  e.preventDefault();
  
  clearFieldErrors();
  
  const email = (emailInput.value || '').trim();
  if (!email) {
    emailError.innerText = 'Email is required';
    emailError.style.display = 'block';
    return;
  }
  
  resendBtn.disabled = true;
  resendBtn.innerText = 'Resendingâ€¦';
  
  try {
    const { fallback, json } = await ajaxPostJSON("{% url 'forgot-password' %}", { email, resend: true });
    
    if (fallback) { 
      form.submit(); 
      return; 
    }
    
    if (json.ok) {
      Toast.show(json.msg || 'Code resent!', 'success');
      if (codeInput) { 
        codeInput.value=''; 
        codeInput.focus(); 
      }
    } else {
      Toast.show(json.msg || 'Unable to resend', 'error');
    }
  } catch (err) {
    Toast.show('Network error', 'error');
  } finally {
    resendBtn.disabled = false;
    resendBtn.innerText = 'Resend code';
  }
});

// Cancel & Close buttons
verifyCancel.addEventListener('click', function(e){ 
  e.preventDefault();
  showOtpRow(false); 
  clearFieldErrors(); 
});

closeModalBtn.addEventListener('click', hidePasswordModal);

// Close modal on outside click
passwordModal.addEventListener('click', function(e){
  if (e.target === passwordModal) {
    hidePasswordModal();
  }
});

// Prevent native submit
form.addEventListener('submit', function(e){
  e.preventDefault();
  return false;
});
</script>

</body>
</html>
